<!--
    File Name		: chat.html
    Version		    : V3.1
    Designer		: å’Œåˆé›…è¼
    Date			: 2021.06.08
    Purpose       	: ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ç”»é¢

    Revision :
    V1.0 : å’Œåˆé›…è¼, 2021.06.08
    V1.1 : å¹³æ¾¤å·§æœ›, 2021.06.08, base.htmlã®é©ç”¨
    v2.0 : å¹³æ¾¤å·§æœ›, 2021.06.12, ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ èªè¨¼æ©Ÿèƒ½ã«å¯¾å¿œ
    V2.1 : æ¾å²¡ä¿®å¹³, 2021.06.15, chat_room_detail.htmlã«å¯¾å¿œ
    V2.2 : å¹³æ¾¤å·§æœ›, 2021.06.20, ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ–‡é€ä¿¡æ©Ÿèƒ½ã¨æŠ•ç¥¨æ©Ÿèƒ½ã®å®Ÿè£…
    V2.3 : æ¾å²¡ä¿®å¹³, 2021.06.20, å¸ä¼šè€…æ±ºå®šæ©Ÿèƒ½ã®è¿½åŠ 
    V3.0 : å¹³æ¾¤å·§æœ›, 2021.07.04, ãƒ‡ã‚¶ã‚¤ãƒ³ã®å¤‰æ›´
    V3.1 : è±Šç”°èˆªå¹³, 2021.07.11, ãƒ­ã‚°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã®æ‹¡å¼µ
-->


<!DOCTYPE html>
<html lang="ja">

<head>

    <meta charset="UTF-8">
    
    <!-- bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>

    <title>{{ room_name }}</title>

    <style type="text/css">
        * {
            font-family:sans-serif;
        }

        body {
            margin: 10px;
            padding: 10px;
        }

        p{
            margin: 10px 30px;
            padding: 10px 30px;
        }

        h2 {
            font-size: 2rem;
            padding: 0em 1em;
            background: linear-gradient(transparent 50%, darkcyan 85%);
            font-weight: bold;
        }

        h3 {
            font-size: 1.5rem;
        }

        #div_container {
        display: flex; /* å­è¦ç´ ã‚’flexé…ç½®ã¨ã™ã‚‹ */
        /*
        flex-direction: column; /* å­è¦ç´ ã®flexé…ç½®ã®æ–¹å‘ã¯åˆ—æ–¹å‘ï¼ˆç¸¦æ–¹å‘ï¼‰
        */
        }

        #div_join_screen {
        display: flex; /* å­è¦ç´ ã‚’flexé…ç½®ã¨ã™ã‚‹ */
        /*
        align-items: center; /*å­è¦ç´ ã‚’ä¸Šä¸‹ä¸­å¤®æƒãˆã¨ã™ã‚‹ã€‚ã€Œdisplay: flexã€å¿…è¦
        */
        z-index: 10;
        }

        #div_chat_screen {
        display: none; /* åˆæœŸçŠ¶æ…‹éè¡¨ç¤º */
        }
    </style>

</head>

<body>

    <h2>{{ room_name }}</h2>
   
    <div id="div_container">

        <!--<div id="div_header">
        <h2>My Chat</h2>
        </div>
        -->
        
        <div id="div_main">

            <div id="div_join_screen">
                <p>
                    ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã€Œ{{ room_name }}ã€ã®èªè¨¼ã«æˆåŠŸã—ã¾ã—ãŸï¼<br>
                    è¡¨ç¤ºåã¨ãƒ«ãƒ¼ãƒ åã‚’ç¢ºèªã®ä¸Šï¼Œï¼»ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ å…¥å®¤ï¼½ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼<br>
                    <b>è¡¨ç¤ºåã¯å¤‰æ›´å¯èƒ½</b>ã§ã™ï¼ã“ã“ã«å…¥åŠ›ã•ã‚ŒãŸè¡¨ç¤ºåãŒãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ å†…ã§è¡¨ç¤ºã•ã‚Œã¾ã™ï¼
                </p>
                
                <center>
                <form action="" onsubmit="onsubmitButton_JoinChat(); return false;" style="text-align: center; width: 100%;">
                    Display name : 
                    <input type="text" id="input_username" value = "{{ user_name }}" autofocus><br /><br>
                    Room name : 
                    <input type="text" id="input_roomname" value = "{{ room_name }}" readonly = "readonly"><br><br>
                    <input type="submit" value="ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ å…¥å®¤" />
                </form>
                </center>
            </div>

            <div id="div_chat_screen">
                Display Name : <b><font size = "4"><span id = "user_name_area"></span></font></b>ã€€
                <button type="button", onclick="room_detail()">éƒ¨å±‹è©³ç´°ãƒšãƒ¼ã‚¸ã¸</button>ã€€
                <button onclick="onclickButton_sikai()">ãƒ©ãƒ³ãƒ€ãƒ å¸ä¼šè€…æ±ºå®š</button>ã€€
                <button onclick="log_out()">ãƒ­ã‚°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>ã€€
                <button type="button", onclick="Button()">ã‚¿ã‚¤ãƒãƒ¼</button>ã€€
                <button onclick="onclickButton_LeaveChat()" style="background-color:lightcoral;"><b>{{ room_name }}</b>ã‚’é€€å‡ºã™ã‚‹</button>ã€€

                <br>
                <input type="hidden" id="text_username" readonly="readonly"> <!-- ãƒ¦ãƒ¼ã‚¶å -->
                <input type="hidden" id="text_roomname" readonly="readonly"><br> <!-- ãƒ«ãƒ¼ãƒ å -->
                
                <!--
                    ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼ã«ã‚ˆã‚‹ãƒœã‚¿ãƒ³æŠ¼ä¸‹ã‚’è¡Œã†ãŸã‚ã«ã€<button>ã§ã¯ãªã<form>ã¨<input type="submit">ã‚’ä½¿ç”¨ã€‚
                    ãƒœã‚¿ãƒ³æŠ¼ä¸‹(=submit)æ™‚ã«ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ãŒè¡Œã‚ã‚Œãªã„ã‚ˆã†ã«ã€onsubmitã®è¨­å®šã®æœ€å¾Œã«"return false;"ã‚’è¿½åŠ ã€‚
                -->
                <form action="" onsubmit="onsubmitButton_Send(); return false;">
                    Message : <input type="text" id="input_message" style="width:500px;" autocomplete="off" autofocus /> <input type="submit" value="é€ä¿¡" />ã€€
                    <button onclick="onclickButton_vote()">æŠ•ç¥¨ã‚’é–‹å§‹ï¼çµ‚äº†</button>ã€€
                </form>
                <p>
                <button onclick="onclickButton_tmp1()">ãªã‚‹ã»ã©ï¼</button>ã€€
                <button onclick="onclickButton_tmp2()">ç§ã‚‚ãã†æ€ã„ã¾ã™ï¼</button>ã€€
                <button onclick="onclickButton_tmp3()">ç†è§£ã—ã¾ã—ãŸï¼</button>ã€€
                <button onclick="onclickButton_tmp4()">ã†ãƒ¼ã‚“â€¦</button>ã€€
                <button onclick="onclickButton_tmp5()">ğŸ‘</button>ã€€
                <button onclick="onclickButton_tmp6()">ğŸ‘</button>ã€€
                <button onclick="onclickButton_tmp7()">âœ‹</button>ã€€
                <button onclick="onclickButton_tmp8()">ğŸ‘</button>ã€€
                <button onclick="onclickButton_tmp9()">ã€‡</button>ã€€
                <button onclick="onclickButton_tmp10()">Ã—</button>ã€€
                <button onclick="onclickButton_tmp11()">â–³</button>ã€€
                </p>

                <ul id="list_message"></ul>

            </div>
        </div>
    </div>

    <script type = "text/javascript">

        const log_data = [];

        const g_elementDivJoinScreen = document.getElementById( "div_join_screen" );
        const g_elementDivChatScreen = document.getElementById( "div_chat_screen" );
        const g_elementInputUserName = document.getElementById( "input_username" );
        const g_elementInputRoomName = document.getElementById( "input_roomname" );

        const g_elementTextUserName = document.getElementById( "text_username" );
        const g_elementTextRoomName = document.getElementById( "text_roomname" );

        const g_elementInputMessage = document.getElementById( "input_message" );
        const g_elementListMessage = document.getElementById( "list_message" );
        
        g_elementDivChatScreen.style.display = "none";  // ãƒãƒ£ãƒƒãƒˆç”»é¢ã®éè¡¨ç¤º

        // WebSocketã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        let ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
        const g_socket = new WebSocket( ws_scheme + "://" + window.location.host + "/ws/chat/" );

{#ã€€ã€€ã€€ã€€ã€€// ã€Œãƒãƒ£ãƒƒãƒˆã«æˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨å‘¼ã°ã‚Œã‚‹é–¢æ•°#}
{#       function onsubmitButton_roomdetail()#}
{#       {#}
{#       }#}

        //ã‚¿ã‚¤ãƒãƒ¼

        function Button() {
            window.open("{% url 'chat_channel:timer' %}", "new",'width=500, height=300')
        }
ã€€
        //éƒ¨å±‹è©³ç´°
        function room_detail(){
            window.open("{% url 'chat_channel:chat_room_detail' chatroom_id %}", "new", "width=500", "height=300")
        }

        // ã€Œãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ å…¥å®¤ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨å‘¼ã°ã‚Œã‚‹é–¢æ•°
        function onsubmitButton_JoinChat()
        {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼å
            let strInputUserName = g_elementInputUserName.value;
            if( !strInputUserName )
            {
                return;
            }
            g_elementTextUserName.value = strInputUserName;
            document.getElementById('user_name_area').innerHTML = strInputUserName;

            // ãƒ«ãƒ¼ãƒ å
            let strInputRoomName = g_elementInputRoomName.value;
            g_elementTextRoomName.value = strInputRoomName;

            // ã‚µãƒ¼ãƒãƒ¼ã«"join"ã‚’é€ä¿¡
            g_socket.send( JSON.stringify( { "data_type": "join", "username": strInputUserName, "roomname": strInputRoomName } ) );

            // ç”»é¢ã®åˆ‡ã‚Šæ›¿ãˆ
            g_elementDivJoinScreen.style.display = "none";  // å‚åŠ ç”»é¢ã®éè¡¨ç¤º
            g_elementDivChatScreen.style.display = "block";  // ãƒãƒ£ãƒƒãƒˆç”»é¢ã®è¡¨ç¤º
        }


        // ã€ŒLeave Chat.ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨å‘¼ã°ã‚Œã‚‹é–¢æ•°
        function onclickButton_LeaveChat()
        {
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆã®ã‚¯ãƒªã‚¢
            while( g_elementListMessage.firstChild )
            {
                g_elementListMessage.removeChild( g_elementListMessage.firstChild );
            }

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼å
            g_elementTextUserName.value = "";

            // ã‚µãƒ¼ãƒãƒ¼ã«"leave"ã‚’é€ä¿¡
            g_socket.send( JSON.stringify( { "data_type": "leave" } ) );

            // ç”»é¢ã®åˆ‡ã‚Šæ›¿ãˆ
            g_elementDivChatScreen.style.display = "none";  // ãƒãƒ£ãƒƒãƒˆç”»é¢ã®éè¡¨ç¤º
//            g_elementDivJoinScreen.style.display = "flex";  // å‚åŠ ç”»é¢ã®è¡¨ç¤º
            location.href = "../chat_room_leave/";
        }

        // ã€ŒSendã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®å‡¦ç†
        function onsubmitButton_Send()
        {
            // é€ä¿¡ç”¨ãƒ†ã‚­ã‚¹ãƒˆHTMLè¦ç´ ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ–‡å­—åˆ—ã®å–å¾—
            let strMessage = g_elementInputMessage.value;
            if( !strMessage )
            {
                return;
            }

            // WebSocketã‚’é€šã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡
            g_socket.send( JSON.stringify( { "message": strMessage } ) );

            // é€ä¿¡ç”¨ãƒ†ã‚­ã‚¹ãƒˆHTMLè¦ç´ ã®ä¸­èº«ã®ã‚¯ãƒªã‚¢
            g_elementInputMessage.value = "";
        }

        // ã€Œãªã‚‹ã»ã©ï¼ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®å‡¦ç†
        function onclickButton_tmp1()
        {
            // WebSocketã‚’é€šã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡
            g_socket.send( JSON.stringify( { "message": "ãªã‚‹ã»ã©ï¼" } ) );
        }

        // ã€Œç§ã‚‚ãã†æ€ã„ã¾ã™ï¼ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®å‡¦ç†
        function onclickButton_tmp2()
        {
            // WebSocketã‚’é€šã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡
            g_socket.send( JSON.stringify( { "message": "ç§ã‚‚ãã†æ€ã„ã¾ã™ï¼" } ) );
        }
        
        // ã€Œç†è§£ã—ã¾ã—ãŸï¼ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®å‡¦ç†
        function onclickButton_tmp3()
        {
            // WebSocketã‚’é€šã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡
            g_socket.send( JSON.stringify( { "message": "ç†è§£ã—ã¾ã—ãŸï¼" } ) );
        }
        
        // ã€Œã†ãƒ¼ã‚“â€¦ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®å‡¦ç†
        function onclickButton_tmp4()
        {
            // WebSocketã‚’é€šã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡
            g_socket.send( JSON.stringify( { "message": "ã†ãƒ¼ã‚“â€¦" } ) );
        }
        
        // ã€ŒğŸ‘ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®å‡¦ç†
        function onclickButton_tmp5()
        {
            // WebSocketã‚’é€šã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡
            g_socket.send( JSON.stringify( { "message": "ğŸ‘" } ) );
        }
        
        // ã€ŒğŸ‘ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®å‡¦ç†
        function onclickButton_tmp6()
        {
            // WebSocketã‚’é€šã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡
            g_socket.send( JSON.stringify( { "message": "ğŸ‘" } ) );
        }
        
        // ã€Œâœ‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®å‡¦ç†
        function onclickButton_tmp7()
        {
            // WebSocketã‚’é€šã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡
            g_socket.send( JSON.stringify( { "message": "âœ‹" } ) );
        }
        
        // ã€ŒğŸ‘ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®å‡¦ç†
        function onclickButton_tmp8()
        {
            // WebSocketã‚’é€šã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡
            g_socket.send( JSON.stringify( { "message": "ğŸ‘" } ) );
        }
        
        // ã€Œã€‡ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®å‡¦ç†
        function onclickButton_tmp9()
        {
            // ã‚µãƒ¼ãƒã«"vote_ok"ã‚’é€ä¿¡
            g_socket.send( JSON.stringify( { "data_type": "vote_ok" } ) );
        }
        
        // ã€ŒÃ—ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®å‡¦ç†
        function onclickButton_tmp10()
        {
            // ã‚µãƒ¼ãƒã«"vote_ng"ã‚’é€ä¿¡
            g_socket.send( JSON.stringify( { "data_type": "vote_ng" } ) );
        }
        
        // ã€Œâ–³ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®å‡¦ç†
        function onclickButton_tmp11()
        {
            // ã‚µãƒ¼ãƒã«"vote_cd"ã‚’é€ä¿¡
            g_socket.send( JSON.stringify( { "data_type": "vote_cd" } ) );
        }

        // ã€ŒæŠ•ç¥¨ã‚’é–‹å§‹ï¼çµ‚äº†ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®å‡¦ç†
        function onclickButton_vote() {
            // ã‚µãƒ¼ãƒã«"vote"ã‚’é€ä¿¡
            g_socket.send( JSON.stringify( { "data_type": "vote" } ) );
        }
        
        //ã€Œå¸ä¼šè€…æ±ºå®šã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã®å‡¦ç†
        function onclickButton_sikai(){
            g_socket.send( JSON.stringify( { "data_type": "sikai" } ) );
        }

        // WebSocketã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡æ™‚ã®å‡¦ç†
        g_socket.onmessage = ( event ) =>
        {
            // è‡ªèº«ãŒã¾ã å‚åŠ ã—ã¦ã„ãªã„ã¨ãã¯ã€ç„¡è¦–ã€‚
            if( !g_elementTextUserName.value )
            {
                return;
            }

            // ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ‡ãƒ¼ã‚¿ã«ãƒ‡ã‚³ãƒ¼ãƒ‰
            let data = JSON.parse( event.data );

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ•´å½¢
            //let strMessage = data["message"];
            let strMessage = data["datetime"] + " - [" + data["username"] + "] " + data["message"];

            log_data.push(strMessage + "\n");

            // æ‹¡æ•£ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆã«è¿½åŠ 
            let elementLi = document.createElement( "li" );
            elementLi.textContent = strMessage;
            g_elementListMessage.prepend( elementLi ); // ãƒªã‚¹ãƒˆã®ä¸€ç•ªä¸Šã«è¿½åŠ 
            //g_elementListMessage.append( elementLi );    // ãƒªã‚¹ãƒˆã®ä¸€ç•ªä¸‹ã«è¿½åŠ 
        };

        // WebSocketã‚¯ãƒ­ãƒ¼ã‚ºæ™‚ã®å‡¦ç†
        g_socket.onclose = ( event ) =>
        {
            // ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ãŸã¨ãä»¥å¤–ã®WebSocketã‚¯ãƒ­ãƒ¼ã‚ºã¯æƒ³å®šå¤–
            console.error( "Unexpected : Chat socket closed." );
        };

        //log
        function log_out(){
            let blob = new Blob( log_data, {type: "text/plan"});
            let link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'log.txt';
            link.click();
        }

    </script>

    <!-- Footer -->
    <footer class="font-small pt-4">
        <div class="footer-copyright text-center py-3">
        <center>
            ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯èŠæµ¦å·¥æ¥­å¤§å­¦æƒ…å ±å·¥å­¦ç§‘ã€Œé«˜åº¦æƒ…å ±æ¼”ç¿’1Bã€ã®2021å¹´åº¦01ç­ã«ã‚ˆã£ã¦ä½œæˆã•ã‚Œã¾ã—ãŸ
        </center>
        </div>
        <!-- /.container -->
    </footer>

</body>

</html>
